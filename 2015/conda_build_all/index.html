<!DOCTYPE html>
<html class="js inlinesvg">
  <head>
    <meta name="generator" content="HTML Tidy for HTML5 for Linux version 4.9.30">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="utf-8">
    <title>
      Building a matrix of conda distributions with conda-build-all by Phil Elson - Software | Science | Python
    </title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width"><!-- Styles -->
    <link rel="stylesheet" href="https://pelson.github.io/theme/css/styles-bluegreen.css" id="theme-styles"><!-- Bootstrap styles -->
    <link rel="stylesheet" href="https://pelson.github.io/theme/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://pelson.github.io/theme/bootstrap/css/bootstrap-theme.min.css"><!-- Font-Awesome -->
    <link rel="stylesheet" href="https://pelson.github.io/theme/font-awesome/css/font-awesome.min.css"><!-- Google Webfonts -->
    <link href="https://pelson.github.io/theme/webfonts.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
  <script src="theme/js/html5-3.6-respond-1.1.0.min.js"></script>
  <![endif]-->
    <link href="https://pelson.github.io/" type="application/atom+xml" rel="alternate" title="Phil Elson - Software | Science | Python ATOM Feed">
    <script type="text/javascript">
    var switchTo5x = true;
    </script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js">
    </script>
    <script type="text/javascript">
    stLight.options({
    publisher: "6668e56b-d9f6-4324-8c39-1543fefa1fdf",
    doNotHash: false,
    doNotCopy: false,
    hashAddressBar: false
    });
    </script>
    <style type="text/css">
    stButton_gradient {height: 100%;}
    </style>
  </head>
  <body>
    <header>
      <div class="widewrapper masthead">
        <div class="container">
          <a href="https://pelson.github.io/" id="logo" class="h1">Phil Elson</a>
        </div>
      </div>
    </header>
    <div class="widewrapper main">
      <div class="container">
        <div class="row">
          <div class="col-md-8 blog-main">
            <h2 id="single">
              Building a matrix of conda distributions with conda-build-all
            </h2><img class="article-image" src="https://pelson.github.io/images/conda_build_all/construction.gif">
            <div class="date entry-info">
              <p>
                Wed 09 December 2015
              </p>
            </div>
            <div class="entry">
              <p>
                Introducing <code>conda-build-all</code>, a tool which extends <code>conda-build</code> to provide powerful build matrix capabilities.
              </p>
              <p>
                Repositories such as <a href="https://github.com/ioos/conda-recipes">conda-forge/stages-recipes</a>, <a href="https://github.com/SciTools/conda-recipes-scitools">SciTools/conda-recipes-scitools</a> and <a href="https://github.com/ioos/conda-recipes">ioos/conda-recipes</a> exist to provide a set of conda recipes, and ultimately, channels from which users can access the product of <code>conda-build</code>-ing those recipes. The build phase of all of these repositories looks very similar: a tool (ObviousCI) computes the build matrix, builds those distributions which haven't already been built, and then uploads them to their respective channels. The functionality is tried and tested, and has been powering these repositories for over a year with huge success, however, I recently had need to use this functionality without wanting to upload the built distributions to <a href="http://conda.anaconda.org">conda.anaconda.org</a> and found the tool didn't <em>quite</em> fit the bill. Additionally, having originally cobbled together ObviousCI with string and sticky-tape to prove the concept of a continuously integrated repo of recipes, I didn't have huge confidence in its ability to function between python/conda/conda-build upgrades.
              </p>
              <p>
                As a result, I have re-factored the build part of ObviousCI into a general purpose library which can now be used for the original "conda recipe repository" usecase as much as it can for the ad-hoc "just build this" usecase. Critically, the most significant part of this re-factoring was adding a huge array of unit and integration tests which can be used to ensure expected behaviour is unchanged through future dependency version upgrades.
              </p>
              <p>
                The new CLI is <code>conda-build-all</code> (BSD license) and is developed at <a href="https://github.com/SciTools/conda-build-all">SciTools/conda-build-all</a>.
              </p>
              <h3>
                The build matrix
              </h3>
              <p>
                So what does a build matrix actually look like? Let's jump in at the deep-end and look at a package which has a numpy C-API dependency. Whilst numpy's ABI is (intended to be) <a href="http://stackoverflow.com/a/18369312/741316">forward-compatible</a>, in practice it is safer to compile against a specific version and "pin" the distribution to that version. Essentially, that means we need to build our recipe N times, where N is the number of numpy versions we wish to support. Of course, the same is true for Python itself, leading to a permutation problem of up to <code>NxM</code> builds (N: number of supported numpy versions; M: number of supported Python versions).
              </p>
              <p>
                The current conda recipe form for such a package looks like:
              </p>
              <div class="highlight">
                <pre>
<span class="kd">package</span><span class="o">:</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">my_library</span>
    <span class="n">version</span><span class="o">:</span> <span class="mf">1.0</span>
<span class="n">requirements</span><span class="o">:</span>
    <span class="n">build</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">python</span>
        <span class="o">-</span> <span class="n">numpy</span> <span class="n">x</span><span class="o">.</span><span class="na">x</span>
    <span class="n">run</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">python</span>
        <span class="o">-</span> <span class="n">numpy</span> <span class="n">x</span><span class="o">.</span><span class="na">x</span>
</pre>
              </div>
              <p>
                Whilst I believe there is <a href="https://github.com/conda/conda-build/pull/650">room for improvement</a> in the recipe definition, it is still pretty easy to define a complex set of build- and run-time dependencies.
              </p>
              <p>
                With the existing <code>conda-build</code> tool, should we want to build this for Python 2.7, 3.4 and 3.5, and against numpy 1.9 and 1.10 (the latest versions of these libraries at the time of writing), things can get a little tedious:
              </p>
              <div class="highlight">
                <pre>
CONDA_PY=27 CONDA_NPY=19 conda build my_library
CONDA_PY=34 CONDA_NPY=19 conda build my_library
CONDA_PY=35 CONDA_NPY=19 conda build my_library
CONDA_PY=27 CONDA_NPY=110 conda build my_library
CONDA_PY=34 CONDA_NPY=110 conda build my_library
CONDA_PY=35 CONDA_NPY=110 conda build my_library
</pre>
              </div>
              <p>
                With <code>conda-build-all</code> the special environment variables are taken care of for you (and importantly there is future scope to generalise beyond Python &amp; numpy) and a build matrix is computed:
              </p>
              <div class="highlight">
                <pre>
<span class="nv">$ </span>conda-build-all my_library
Resolving distributions from <span class="m">1</span> recipes... 
Computed that there are <span class="m">7</span> distributions from the <span class="m">1</span> recipes:
Resolved dependencies, will be built in the following order: 
    my_library-1.0-np19py26_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py34_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py34_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
</pre>
              </div>
              <p>
                Notice how this command is not conceptually equivalent to the original <code>conda-build</code> calls as I have not asked for particular versions to build against. <code>conda-build-all</code> has chosen the top two major versions and within those, the top two minor versions of the packages which require "pinning". Unfortunately, that included Python 2.6, which I didn't really want - to resolve that, we can add extra conditions to our build:
              </p>
              <div class="highlight">
                <pre>
<span class="nv">$ </span>conda-build-all my_library --matrix-conditions <span class="s2">"python &gt;=2.7"</span>
Fetching package metadata: ........
Resolving distributions from <span class="m">1</span> recipes... 
Computed that there are <span class="m">6</span> distributions from the <span class="m">1</span> recipes:
Resolved dependencies, will be built in the following order: 
    my_library-1.0-np110py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py34_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py34_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
</pre>
              </div>
              <p>
                We now have functionally equivalent behaviour that will move forwards as new Python and numpy versions become available.
              </p>
              <h3>
                Building multiple recipes in a single call
              </h3>
              <p>
                <code>conda-build-all</code> knows what a conda recipe looks like, and will traverse the directories you give it to look for things to build.
              </p>
              <p>
                Supposing we have a directory of recipes which we wish to build, such as the following:
              </p>
              <div class="highlight">
                <pre>
<span class="nv">$ </span>find * -name meta.yaml -exec sh -c <span class="s2">"echo RECIPE: {}; cat {}; echo"</span> <span class="se">\;</span>
RECIPE: my_recipes_directory/my_library/meta.yaml
package:
    name: my_library
    version: 1.0
requirements:
    build:
        - python
        - numpy x.x
    run:
        - python
        - numpy x.x

RECIPE: my_recipes_directory/my_other_library/meta.yaml
package:
    name: my_other_library
    version: 1.0
requirements:
    build:
        - python
        - numpy x.x
    run:
        - python
        - numpy x.x
</pre>
              </div>
              <p>
                We can simply call <code>conda-build-all</code> on the directory of recipes to have them built appropriately:
              </p>
              <div class="highlight">
                <pre>
<span class="nv">$ </span>conda-build-all my_recipes_directory --matrix-conditions <span class="s2">"python 2.7.*|3.5.*"</span>
Fetching package metadata: ........
Resolving distributions from <span class="m">2</span> recipes... 
Computed that there are <span class="m">8</span> distributions from the <span class="m">2</span> recipes:
Resolved dependencies, will be built in the following order: 
    my_library-1.0-np110py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_other_library-1.0-np110py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_other_library-1.0-np19py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_other_library-1.0-np110py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_other_library-1.0-np19py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
</pre>
              </div>
              <p>
                This functionality becomes invaluable when we wish to build many packages, such is the case for the conda-recipes repositories mentioned earlier.
              </p>
              <h3>
                Only building the missing distributions
              </h3>
              <p>
                The build matrix is supremely useful, but it does come at the cost of the extra time needed to build the many distributions. With repositories full of recipes, it is easy to come to hundreds of build matrix items. If we want to be able to run <code>conda-build-all</code> on a regular bsis, we can't reasonably expect to build each of those items each time. Therefore, <code>conda-build-all</code> has the ability to inspect various locations to determine if a distribution has already been built. In fact, the default behaviour is to inspect the local conda-build directory to determine if a distribution has already been built locally. Other options include the ability to inspect conda channels as well as arbitrary local directories. Supposing we wanted the <code>pelson/channel/testing</code> channel to have all of the built distributions from <code>my_recipes_directory</code>, we can use <code>conda-build-all</code> to good effect:
              </p>
              <div class="highlight">
                <pre>
conda-build-all my_recipes_directory/ --matrix-conditions "python 2.7.*|3.5.*" \
    --inspect-channels "pelson/channel/testing" \
    --upload-channels "pelson/channel/testing" \
    --no-inspect-conda-bld-directory
</pre>
              </div>
              <h3>
                Summary
              </h3>
              <p>
                <code>conda-build-all</code> is a tool which builds on top of <code>conda-build</code> to give powerful build-matrix options when building conda distributions. It has come from <code>ObviousCI</code>, whose primary objective was to simplify the build and upload of many recipes in a Continuous Integration environment. In migrating the codebase from <code>ObviousCI</code> several new test strategies have been developed - making <code>conda-build-all</code> easier to maintain, and giving rise to the possibility of improving the <code>conda</code> and <code>conda-build</code> test suites themselves.
              </p>
            </div>
            <hr>
            <div id="share_buttons">
              <span class="st_googleplus_hcount" displaytext="Google +"></span> <span class="st_facebook_hcount" displaytext="Facebook"></span> <span class="st_twitter_hcount" displaytext="Tweet"></span> <span class="st_pinterest_hcount" displaytext="Pinterest"></span> <span class="st_email_hcount" displaytext="Email"></span> <span class="st_sharethis_hcount" displaytext="ShareThis"></span> <span class="st_fblike_hcount" displaytext="Facebook Like"></span>
            </div><br>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
            var disqus_shortname = "pelson";
            var disqus_identifier = "conda_build_all";

            (function() {
            var dsq = document.createElement("script");
            dsq.type = "text/javascript";
            dsq.async = true;
            dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
            (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          </div>
          <aside class="col-md-4 blog-aside">
            <div class="aside-widget">
              <header>
                <h3>
                  Most recent articles
                </h3>
              </header>
              <div class="body">
                <ul class="pelson-list">
                  <li>
                    <a href="https://pelson.github.io/2015/conda_build_all/">Building a matrix of conda distributions with conda-build-all</a>
                  </li>
                  <li>
                    <a href="https://pelson.github.io/2015/conda_execute/">Running scripts in temporary conda environments with conda execute</a>
                  </li>
                  <li>
                    <a href="https://pelson.github.io/2014/nbagg_backend/">Interactive matplotlib figures in the IPython notebook - they've landed!</a>
                  </li>
                  <li>
                    <a href="https://pelson.github.io/2013/massive_virtual_arrays_with_biggus/">Dealing with arrays which are bigger than memory - an intoduction to biggus</a>
                  </li>
                  <li>
                    <a href="https://pelson.github.io/2013/working_with_colors_in_matplotlib/">Working with colours in matplotlib</a>
                  </li>
                </ul><a href="https://pelson.github.io/archives.html">
                <h4>
                  See all articles
                </h4></a>
              </div>
            </div>
            <div class="aside-widget">
              <header>
                <h3>
                  Find other articles by tag
                </h3>
              </header>
              <div class="body">
                <ul class="tags">
                  <li>
                    <a href="https://pelson.github.io/tag/biggus/">biggus</a>
                  </li>
                  <li class="active">
                    <a href="https://pelson.github.io/tag/conda/">conda</a>
                  </li>
                  <li>
                    <a href="https://pelson.github.io/tag/large-data/">large data</a>
                  </li>
                  <li>
                    <a href="https://pelson.github.io/tag/matplotlib/">matplotlib</a>
                  </li>
                  <li>
                    <a href="https://pelson.github.io/tag/python/">Python</a>
                  </li>
                </ul>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>
    <footer>
      <div class="widewrapper footer">
        <div class="container">
          <div class="row">
            <div class="col-xs-6 footer-widget">
              <h3>
                <i class="fa fa-envelope"></i>Contact
              </h3>
              <ul class="unstyled">
                <li>
                  <a href="https://github.com/pelson"><i class="fa fa-github fa-3x"></i> @pelson on Github</a>
                </li>
                <li>
                  <a href="https://twitter.com/pypelson"><i class="fa fa-twitter fa-3x"></i> @pypelson</a>
                </li>
                <li>
                  <a href="http://stackoverflow.com/users/741316/pelson"><i class="fa fa-stack-overflow fa-3x"></i> @pelson on stackoverflow</a>
                </li>
                <li>
                  <a href="http://uk.linkedin.com/in/philipelson/"><i class="fa fa-linkedin-square fa-3x"></i> LinkedIn</a>
                </li>
                <li>
                  <a href="https://bitbucket.org/pelson"><i class="fa fa-bitbucket fa-3x"></i> Bitbucket</a>
                </li>
                <li>
                  <a href="https://plus.google.com/u/1/103760955300350111400"><i class="fa fa-google-plus-square fa-3x"></i> Google+</a>
                </li>
                <li>
                  <a><i class="fa fa-envelope fa-3x"></i> <span style="unicode-bidi:bidi-override; direction:rtl;">moc.liamg <span style="display: none;">_ignore_</span>@golb+bup.noslep</span></a>
                </li>
              </ul>
            </div>
            <div class="col-xs-6 footer-widget">
              <h3>
                <i class="fa fa-info-circle"></i>About
              </h3><span>This site is generated using a combination of Pelican and IPython notebook, the source can be found at <a href="https://github.com/pelson/pelson.github.io">https://github.com/pelson/pelson.github.io</a>.</span>
            </div>
          </div>
        </div>
      </div>
      <div class="widewrapper copyright">
        <div class="container">
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://pelson.github.io/theme/creative_commons.88x31.png"></a> <a href="https://pelson.github.io"><span>pelson.github.io</span></a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
        </div>
      </div>
    </footer>
    <script src="https://pelson.github.io/theme/jquery.min.js">
    </script> 
    <script src="https://pelson.github.io/theme/bootstrap/js/bootstrap.min.js">
    </script> 
    <script src="https://pelson.github.io/theme/modernizr.js">
    </script> 
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29774503-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script> <a href="http://github.com/pelson/pelson.github.io"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>
  </body>
</html>
